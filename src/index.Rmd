---
title: "Life Expectancy (Revised)"
subtitle: "Instructor: Dr. Le Nhat Tan"
date: "`r Sys.Date()`"
author:
  - name: "Dat Thanh Tran"
output:
  rmdformats::robobook:
    keep_md: true
    thumbnails: true
    lightbox: true
    gallery: true
    use_bookdown: true
---

# Life Expectancy - 2021/12/31

## Get Life Tables

```{r, message=F}
library(tidyverse)
library(rvest)
library(glue)
library(tools)

webpage <- "https://www.mortality.org/" %>%
  read_html %>%
  html_nodes(xpath = "/html/body/div[1]/div/div[3]/ul/li")

countries <- webpage %>%
  html_text(trim = TRUE)

codes <- webpage %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  substring(23)

get_life_table <- function(country) {
  data <- codes[which(countries == country)] %>%
    map(~ {
      map_df(c("female", "male"), function(gender) {
        path_prefix <-
          ifelse(gender == "female", "fltper_1x1", "mltper_1x1")
        file_path <- glue("{path_prefix}/{.}.{path_prefix}.txt")
        read_table(file_path, skip = 2) %>%
          mutate(Country = country, Gender = gender)
      })
    }) %>%
    bind_rows
}

life_tables <- map(countries, get_life_table) %>%
  bind_rows %>%
  mutate(Age = as.numeric(str_replace(Age, "110\\+", "110"))) %>%
  filter_all(all_vars(!is.na(.)))

life_tables %>%
  glimpse
```

## Visualize Data for the U.S.A

```{r, message=F, warning=F}
usa_2019 <- life_tables %>%
  filter(Country == "U.S.A.", Year == 2019)

usa_2019 %>%
  glimpse
```

```{r, message=F, warning=F}
usa <- life_tables %>%
  filter(Country == "U.S.A.")

usa %>%
  glimpse
```

### Mortality Rate and Age by Gender (U.S.A., 2019)

```{r, message=F, warning=F}
usa_2019 %>%
  ggplot(aes(x = Age, y = qx, group = 1)) +
  geom_line(col = "blue") +
  labs(x = "Age",
       y = expression(paste("Mortality Rate")),
       title = "Mortality Rate and Age by Gender (U.S.A., 2019)") +
  facet_wrap(~ toTitleCase(Gender))
```

### Mortality Rate and Age by Year and Gender (U.S.A., 1933-2021)

```{r, message=F, warning=F}
usa %>%
  ggplot(aes(x = Age, y = qx, color = Year)) +
  geom_line(aes(group = Year)) +
  labs(x = "Age",
       y = expression(paste("Mortality Rate")),
       title = "Mortality Rate and Age by Year and Gender (U.S.A., 1933-2021)") +
  facet_wrap(~ toTitleCase(Gender))
```

### Log Mortality Rate and Age by Gender (U.S.A., 2019)

```{r, message=F, warning=F}
usa_2019 %>%
  ggplot(aes(x = Age, y = log(qx), group = 1)) +
  geom_line(col = "blue") +
  labs(x = "Age",
       y = expression(paste("Log Mortality Rate")),
       title = "Log Mortality Rate and Age by Gender (U.S.A., 2019)") +
  facet_wrap(~ toTitleCase(Gender))
```

### Log Mortality Rate and Age by Year and Gender (U.S.A., 1933-2021)

```{r, message=F, warning=F}
usa = life_tables %>%
  filter(Country == "U.S.A.")

usa %>%
  ggplot(aes(x = Age, y = log(qx), color = Year)) +
  geom_line(aes(group = Year)) +
  labs(x = "Age",
       y = "Log Mortality Rate",
       title = "Log Mortality Rate and Age by Year and Gender (U.S.A., 1933-2021)") +
  facet_wrap(~ toTitleCase(Gender))
```

### Survival Probability and Future Lifetime for People at Age 18 (U.S.A., 2019)

```{r, message=F, warning=F}
usa_2019 %>%
  filter(Age >= 18) %>%
  group_by(Gender) %>%
  mutate(survival = cumprod(1 - qx),
         k = 0:(n() - 1)) %>%
  ungroup %>% ggplot(aes(x = k, y = survival)) +
  geom_line(col = "blue") +
  labs(x = "Future Lifetime",
       y = expression("Survival Probability"),
       title = "Survival Probability and Future Lifetime for People at Age 18 (U.S.A., 2019)") +
  facet_wrap(~ toTitleCase(Gender))
```

### Survival Probability and Future Lifetime by Year and Gender for People at Age 18 (U.S.A., 1933-2021)

```{r, message=F, warning=F}
usa %>%
  filter(Age >= 18) %>%
  group_by(Gender, Year) %>%
  mutate(survival = cumprod(1 - qx), k = 0:(n() - 1)) %>%
  ungroup %>%
  ggplot(aes(x = k, y = survival, color = Year)) +
  geom_line(aes(group = Year)) +
  labs(x = "Future Lifetime",
       y = expression("Survival Probability"),
       title = "Survival Probability and Future Lifetime by Year and Gender for People at Age 18 (U.S.A., 1933-2021)") +
  facet_wrap(~ toTitleCase(Gender))
```

### Future Lifetime and Age by Gender (U.S.A., 2019)

```{r, message=F, warning=F}
usa_2019 %>%
  group_by(Gender) %>%
  arrange(Age) %>%
  mutate(
    px = 1 - qx,
    kpx = cumprod(px),
    future_lifetime = rev(cumsum(rev(kpx)))
  ) %>%
  ggplot(aes(x = Age, y = future_lifetime)) +
  geom_line(col = "blue") +
  labs(title = "Future Lifetime and Age by Gender (U.S.A., 2019)",
       x = "Age",
       y = "Future Lifetime") +
  theme_minimal() +
  facet_wrap(~ toTitleCase(Gender))
```

### Future Lifetime and Age by Year (U.S.A., 2019)

```{r, message=F, warning=F}
usa %>%
  group_by(Gender, Year) %>%
  arrange(Age) %>%
  mutate(
    px = 1 - qx,
    kpx = cumprod(px),
    future_lifetime = rev(cumsum(rev(kpx)))
  ) %>%
  ungroup %>%
  ggplot(aes(x = Age, y = future_lifetime, color = Year)) +
  geom_line(aes(group = Year)) +
  labs(title = "Future Lifetime and Age by Year (U.S.A., 2019)",
       x = "Age",
       y = "Future Lifetime") +
  theme_minimal() +
  facet_wrap(~ toTitleCase(Gender))
```

### Life Expectancy and Year by Gender (U.S.A.)

```{r, message=F, warning=F}
usa %>%
  group_by(Gender, Year) %>%
  mutate(kpx = cumprod(1 - qx),
         life_expectancy = sum(kpx)) %>%
  filter(Age == 0) %>%
  ggplot(aes(x = Year, y = life_expectancy, color = Gender)) +
  geom_line() +
  scale_color_discrete(name = "Gender", labels = c("Female", "Male")) +
  labs(x = "Year",
       y = "Life Expectancy",
       title = "Life Expectancy and Year by Gender (U.S.A.)")
```

## Visualize Data

### Life Expectancy and Year by Country and Gender

```{r, message=F, warning=F}
life_tables %>%
  group_by(Year, Country, Gender) %>%
  mutate(kpx = cumprod(1 - qx),
         life_expectancy = sum(kpx)) %>%
  filter(Age == 0) %>%
  ungroup %>%
  ggplot(aes(x = Year, y = life_expectancy, color = Country)) +
  geom_point() +
  facet_wrap(~ toTitleCase(Gender)) +
  ggtitle("Life Expectancy and Year by Country and Gender") +
  xlab("Year") + ylab("Life Expectancy") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Life Expectancy and Year by Gender and Country

```{r, message=F, warning=F}
life_tables %>%
  group_by(Gender, Year) %>%
  mutate(kpx = cumprod(1 - qx),
         life_expectancy = sum(kpx)) %>%
  filter(Age == 0) %>%
  ggplot(aes(x = Year, y = life_expectancy, color = Gender)) +
  geom_line() +
  scale_color_discrete(name = "Gender", labels = c("Female", "Male")) +
  facet_wrap(~ Country) +
  ggtitle("Life Expectancy and Year by Gender and Country") +
  xlab("Year") + ylab("Life Expectancy") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Visualize Data with Gapminder

```{r, message=F, warning=F}
library(gapminder)

gapminder_modified <- gapminder %>%
  # Standardize country names
  mutate(
    country = case_when(
      country == "United States" ~ "U.S.A.",
      country == "Hong Kong, China" ~ "Hong Kong",
      country == "Korea, Rep." ~ "Republic of Korea",
      country == "United Kingdom" ~ "U.K.",
      country == "Slovak Republic" ~ "Slovakia",
      TRUE ~ country
    )
  )

life_tables_gapminder = life_tables %>%
  filter(
    # Filter mutual countries of the tables
    Country %in% c(
      "Australia",
      "Austria",
      "Belgium",
      "Bulgaria",
      "Canada",
      "Chile",
      "Croatia",
      "Denmark",
      "Finland",
      "France",
      "Germany",
      "Greece",
      "Hong Kong",
      "Hungary",
      "Iceland",
      "Ireland",
      "Israel",
      "Italy",
      "Japan",
      "Netherlands",
      "New Zealand",
      "Norway",
      "Poland",
      "Portugal",
      "Republic of Korea",
      "Slovenia",
      "Spain",
      "Sweden",
      "Switzerland",
      "Taiwan",
      "U.K.",
      "U.S.A."
    )
  ) %>%
  inner_join(gapminder_modified, by = c("Year" = "year", "Country" = "country"))
```

### Life Expectancy and GDP per Capita by Continent, Population, and Gender in 2007

```{r, message=F, warning=F}
life_tables_gapminder %>%
  filter(Year == 2007) %>%
  group_by(Year, Country, Gender) %>%
  mutate(kpx = cumprod(1 - qx),
         life_expectancy = sum(kpx)) %>%
  filter(Age == 0) %>%
  ungroup %>%
  ggplot(aes(
    x = gdpPercap,
    y = life_expectancy,
    color = continent,
    size = pop
  )) +
  geom_point() +
  facet_wrap(~ toTitleCase(Gender)) +
  geom_text(aes(label = Country),
            hjust = 1,
            vjust = 1,
            size = 2) +
  ggtitle("Life Expectancy and GDP per Capita by Continent, Population, and Gender in 2007") +
  xlab("GDP per Capita") + ylab("Life Expectancy") +
  labs(color = "Continent", size = "Population")
```

### Top Life Expectancy and Year by Continent and Gender

```{r, message=F, warning=F}
# Calculate life expectancy for each country, gender, and year
life_expectancy_data <- life_tables_gapminder %>%
  group_by(Year, Country, Gender) %>%
  mutate(kpx = cumprod(1 - qx),
         life_expectancy = sum(kpx)) %>%
  filter(Age == 0) %>%
  ungroup

# Calculate the range of life expectancy for each country
life_expectancy_range <- life_expectancy_data %>%
  group_by(continent, Country, Gender) %>%
  summarize(life_expectancy_range = max(life_expectancy) - min(life_expectancy)) %>%
  ungroup

# Select top 1 country per continent based on life expectancy range
top_le <- life_expectancy_range %>%
  group_by(continent, Gender) %>%
  top_n(1, wt = life_expectancy_range) %>%
  ungroup

# Filter the original data to include only the selected countries
lt_top_le <- life_expectancy_data %>%
  semi_join(top_le, by = c("Country", "continent", "Gender"))

# Plot the results
lt_top_le %>%
  ggplot(aes(x = Year, y = life_expectancy, color = Country)) +
  geom_line() +
  facet_wrap(~ toTitleCase(Gender)) +
  ggtitle("Top Life Expectancy and Year by Continent and Gender") +
  xlab("Year") + ylab("Life Expectancy") +
  labs(color = "Country")
```

### Top Life Expectancy and Year by Continent, Gender and Population

```{r, message=F, warning=F}
lt_top_le %>%
  ggplot(aes(x = Year, y = life_expectancy, color = Country, size = pop)) +
  geom_point() +
  facet_wrap(~ toTitleCase(Gender)) +
  geom_text(aes(label = Country),
            hjust = 1,
            vjust = 2,
            size = 2) +
  ggtitle("Top Life Expectancy and Year by Continent, Gender and Population") +
  xlab("Year") + ylab("Life Expectancy") +
  labs(color = "Country", size = "Population")
```

### Life Expectancy and Top GDP per Capita by Continent, Population, and Year

```{r, message=F, warning=F}
# Calculate life expectancy for each country, and year
life_expectancy <- life_tables_gapminder %>%
  group_by(Year, Country) %>%
  mutate(kpx = cumprod(1 - qx),
         life_expectancy = sum(kpx)) %>%
  filter(Age == 0) %>%
  ungroup

# Calculate the range of GDP for each country
gdp_range <- life_tables_gapminder %>%
  group_by(continent, Country) %>%
  summarize(
    gdpPercap_range = max(gdpPercap, na.rm = TRUE) - min(gdpPercap, na.rm = TRUE)
  ) %>%
  ungroup

# Select top 2 countries based on GDP per capita range
top_gdp <- gdp_range %>%
  group_by(continent) %>%
  top_n(2, wt = gdpPercap_range) %>%
  ungroup

# Filter the original data to include only the selected countries
lt_top_gdp <- life_expectancy %>%
  semi_join(top_gdp, by = c("Country", "continent"))

# Plot the results
lt_top_gdp %>%
  ggplot(aes(
    x = gdpPercap,
    y = life_expectancy,
    color = continent,
    size = pop
  )) +
  geom_point() +
  facet_wrap(~ Year) +
  geom_text(aes(label = Country),
            hjust = 1,
            vjust = 1,
            size = 2) +
  ggtitle("Life Expectancy and Top GDP per Capita by Continent, Population, and Year") +
  xlab("GDP per Capita") + ylab("Life Expectancy") +
  labs(color = "Continent", size = "Population") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
